--SCRIPT PARA EXTRACAO DE DADOS 
SELECT 	DISTINCT 
	C.COD_AREA "EQUIPE",
	C.MICROAREA "MICRO",
	C.NUMERO "NUMERO FAMILIA",
	TO_CHAR(B.DATA_ATIVACAO, 'DD/MM/YYYY') "DATA_CADASTRO",
	CASE WHEN B.SEXO = TRUE THEN 'MACULINO' ELSE 'FEMININO' END "SEXO",
	TO_CHAR(B.DATA_NASCIMENTO,'DD/MM/YYYY') "DATA_DE_NASCIMENTO",
	EXTRACT (YEAR FROM AGE (B.DATA_NASCIMENTO))"IDADE",
	CASE WHEN B.FREQUENTA_ESCOLA = TRUE THEN 'SIM' ELSE 'NAO' END "FREQUENTA_ESCOLA",
	CASE WHEN I.CEP = '00000000' OR I.CEP IS NULL THEN '00000000' ELSE I.CEP END "CEP_LOGRADOURO",
	CASE WHEN I.CEP = '00000000' OR I.CEP IS NULL THEN 'Nao_informado' ELSE J.NOME END "BAIRRO_DE_MORADIA",
	B.POVO_COMUNIDADE_TRADICIONAL "COMUNIDADE_MORADIA",
	K.DESCRICAO "TIPO_DE_DOMICILIO",
	CASE WHEN C.ENERGIA_ELETRICA = TRUE THEN 'SIM' ELSE 'NAO' END "EXISTENCIA_DE_ENERGIA_ELETRICA",
	L.DESCRICAO "DESTINO_DO_LIXO",
	M.DESCRICAO "ABASTECIMENTO_DE_AGUA",
	N.DESCRICAO "TRATAMENTO_DE_AGUA",
	O.DESCRICAO "ESGOTAMENTO_SANITARIO",
	Z.NOME "POSSUI_PLANO_DE_SAUDE",
	ARRAY_TO_STRING (ARRAY_AGG(DISTINCT T.DESCRICAO ORDER BY T.DESCRICAO), ', ') "EM_CASO_DE_DOENCA_PROCURA",
	CASE WHEN B.PLANTAS_MEDICINAIS IS NULL THEN 'NAO' ELSE 'SIM' END "USA_PLANTAS_MEDICINAIS",
	CASE WHEN C.ANIMAIS_DOMICILIO =TRUE THEN 'SIM' ELSE 'NAO' END "TEM_ANIMAIS_NO_DOMICILIO",
	ARRAY_TO_STRING (ARRAY_AGG(DISTINCT R.DESCRICAO ORDER BY R.DESCRICAO), ', ') "QUAL(IS)",
	ARRAY_TO_STRING (ARRAY_AGG(DISTINCT V.DESCRICAO ORDER BY V.DESCRICAO), ', ') "MEIOS_DE_COMUNICACAO_QUE_UTILIZA",
	ARRAY_TO_STRING (ARRAY_AGG(DISTINCT Y.DESCRICAO ORDER BY Y.DESCRICAO), ', ') "MEIOS_DE_TRANSPORTE_QUE_UTILIZA",
	CASE WHEN B.GRUPO_COMUNITARIO = TRUE THEN 'SIM, NAO INFORMOU QUAL' ELSE 'NAO' END "PARTICIPACAO_EM_GRUPOS_COMUNITARIOS",
	C.RENDA_FAMILIAR "RENDA_FAMILIAR",
	CASE WHEN C.BOLSA_FAMILIA = TRUE THEN 'SIM' ELSE 'NAO' END "VULNERABILIDADE_SOCIAL",
	CASE WHEN C.BOLSA_FAMILIA = TRUE THEN 'SIM' ELSE 'NAO' END "FAMILIA_BENEFICIARIA_BOLSA_FAMILIA",
	B.NIS "NIS",
	C.ESCORE_RISCO "ESCALA DE COELHO UFES"
FROM SIABFACIL.PESSOA B
LEFT JOIN SIABFACIL.FAMILIA C ON B.FAMILIA_ID = C.ID
LEFT JOIN CNES.LFCES037 D ON C.COD_AREA = D.COD_AREA
LEFT JOIN CNES.LFCES018 E ON E.PROF_ID = C.PROF_ID
LEFT JOIN SIABFACIL.PESSOA_LOG F ON F.PESSOA_ID = B.ID
LEFT JOIN CNES.NFCES038 G ON G.CD_RACA = B.CD_RACA
LEFT JOIN SIABFACIL.LOGRADOURO I ON I.ID = C.LOGRADOURO_ID
LEFT JOIN SIABFACIL.BAIRRO J ON J.ID = I.BAIRRO_ID
LEFT JOIN SIABFACIL.TIPO_DE_CASA K ON K.ID = C.TIPO_DE_CASA_ID
LEFT JOIN SIABFACIL.DESTINO_DO_LIXO L ON L.ID = C.DESTINO_DO_LIXO_ID
LEFT JOIN SIABFACIL.ORIGEM_DA_AGUA M ON M.ID = C.ORIGEM_DA_AGUA_ID
LEFT JOIN SIABFACIL.TRATAMENTO_DE_AGUA N ON N.ID = C.TRATAMENTO_DE_AGUA_ID
LEFT JOIN SIABFACIL.DESTINO_DO_ESGOTO O ON O.ID = C.DESTINO_DO_ESGOTO_ID
LEFT JOIN SIABFACIL.OBITO P ON P.PESSOA_ID = B.ID
LEFT JOIN SIABFACIL.FAMILIA_TIPO_ANIMAL Q ON Q.FAMILIA_ID = C.ID
LEFT JOIN SIABFACIL.TIPO_ANIMAL R ON R.ID = Q.TIPO_ANIMAL_ID
LEFT JOIN SIABFACIL.FAMILIA_EM_CASO_DE_DOENCA S ON S.FAMILIA_ID = C.ID
LEFT JOIN SIABFACIL.EM_CASO_DE_DOENCA T ON T.ID = S.EM_CASO_DE_DOENCA_ID
LEFT JOIN SIABFACIL.FAMILIA_MEIO_DE_COMUNICACAO U ON U.FAMILIA_ID = C.ID
LEFT JOIN SIABFACIL.MEIO_DE_COMUNICACAO V ON V.ID = U.MEIO_DE_COMUNICACAO_ID
LEFT JOIN SIABFACIL.FAMILIA_MEIO_DE_TRANSPORTE X ON X.FAMILIA_ID = C.ID
LEFT JOIN SIABFACIL.MEIO_DE_TRANSPORTE Y ON Y.ID = X.MEIO_DE_TRANSPORTE_ID
LEFT JOIN SIABFACIL.PLANO_DE_SAUDE Z ON B.PLANO_DE_SAUDE_ID = Z.ID
WHERE C.DATA_DESATIVACAO IS NULL
AND C.COD_AREA IS NOT NULL
AND (C.LOGRADOURO_ID IS NOT NULL AND C.LOGRADOURO_ID <> 166913) --NAO CARREGAR OS REGISTROS SEM ENDERECO OU COM ENDERECO NAO INFORMADO
GROUP BY C.COD_AREA, C.MICROAREA, C.NUMERO, B.NOME, B.DATA_NASCIMENTO, D.NM_REFERENCIA, D.CO_EQUIPE, B.DNV, B.CPF, E.NOME_PROF, 
		B.CNS, B.NOME_DA_MAE, B.DATA_ATIVACAO, B.SEXO, G.DS_RACA, B.FREQUENTA_ESCOLA, I.NOME, C.NUMERO_ENDERECO,
		C.OBS_ENDERECO, I.CEP, J.NOME, B.TELEFONE, B.EMAIL, K.DESCRICAO, C.ENERGIA_ELETRICA, L.DESCRICAO, M.DESCRICAO, N.DESCRICAO,
		O.DESCRICAO, B.PLANO_DE_SAUDE_ID, B.PLANTAS_MEDICINAIS, C.ANIMAIS_DOMICILIO, B.SALARIO, C.BOLSA_FAMILIA, C.BOLSA_FAMILIA,
		C.BOLSA_FAMILIA, B.NIS, P.DATA, B.ID, Z.NOME, C.RENDA_FAMILIAR, C.ESCORE_RISCO

