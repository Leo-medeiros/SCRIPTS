--codigo mun ibirarema: 3519501
--codigo mun RIO 3304557
--codigo mun POA 4314902

--select co_equipe from cnes.lfces037;
--PSF II  update cnes.lfces037 set co_equipe = 0001532766
--update cnes.lfces037 set co_equipe = 0001532766


--SCRIPT PARA CORRIGIR LOGS ABERTOS
update siabfacil.pessoa_familia_log set usuario_saida_id = 1000, data_saida = 
	(select data_entrada from siabfacil.pessoa_familia_log where id in --IDENTIFICAR A DATA ENTRADA MAIS ATUAL
		(select MAX(id) from siabfacil.pessoa_familia_log where pessoa_id in 
			(select MAX(pessoa_id) --IDENTIFICAR O REGISTRO DA PESSOA COM MAIS DE UM LOG ABERTO
				from siabfacil.pessoa_familia_log A
				where data_saida is null
				group by pessoa_id
				having count(pessoa_id)>1
				LIMIT 1
			) 
		and data_saida is null 
		group by pessoa_id 
		order by pessoa_id
		) 
	)
where id in 
	(select MIN(id) from siabfacil.pessoa_familia_log where pessoa_id in  --IDENTIFICAR O REGISTRO QUE NAO FOI FECHADO
		(select MAX(pessoa_id)--IDENTIFICAR O REGISTRO DA PESSOA COM MAIS DE UM LOG ABERTO
			from siabfacil.pessoa_familia_log A
			where data_saida is null
			group by pessoa_id
			having count(pessoa_id)>1
			LIMIT 1
		) 
	and data_saida is null 
	group by pessoa_id 
	order by pessoa_id
	);
	
	

--SCRIPT PARA CARREGAR SOMENTE CADASTROS DA COMPETENCIA A SER ENVIADA	
DELETE FROM SIABFACIL.PESSOA_FAMILIA_LOG 
WHERE PESSOA_ID NOT IN 
 (SELECT A.ID
  FROM SIABFACIL.PESSOA A 
  INNER JOIN SIABFACIL.FAMILIA B ON A.FAMILIA_ID = B.ID
  WHERE A.DATA_DESATIVACAO IS NULL
  AND B.DATA_DESATIVACAO IS NULL
  AND A.FAMILIA_ID IS NOT NULL
  AND B.COD_AREA IS NOT NULL
  AND A.DATA_ATIVACAO >= '2017-02-01'
  AND A.DATA_ATIVACAO <= '2017-08-31'
  --AND EXTRACT(MONTH FROM A.DATA_ATIVACAO ) = 07
  --AND EXTRACT(YEAR FROM A.DATA_ATIVACAO ) = 2017
 );


--SCRIPT CORRIGIR POSICAO FAMILIAR DIFERENTES ENTRE PESSOA E PESSOA_FAMILIA_LOG
UPDATE siabfacil.pessoa_familia_log SET posicao_familiar_id = pessoa.posicao_familiar_id
FROM siabfacil.pessoa 
WHERE pessoa_familia_log.pessoa_id = pessoa.id
AND pessoa_familia_log.pessoa_id IN 
	(
	 SELECT B.pessoa_id
	 FROM siabfacil.pessoa A
	 INNER JOIN siabfacil.pessoa_familia_log B ON A.id = B.pessoa_id
	 WHERE A.posicao_familiar_id <> B.posicao_familiar_id
	)
AND pessoa_familia_log.posicao_familiar_id <> pessoa.posicao_familiar_id;


--SCRIPT PARA ATUALIZAR TODOS PARA SITUACAO DE RUA = NAO
UPDATE siabfacil.pessoa SET situacao_rua = FALSE WHERE situacao_rua IS null;


--SCRIPT PARA ATUALIZAR TIPO DE LOGRADOURO PARA RUA
UPDATE siabfacil.logradouro SET tipo_logradouro_id = 081;


--SCRIPT ATUALIZAR PARA NULL OS REGISTROS COM LOCALIZACAO URBANA E COM POSSE DOMICILIO INFORMADA
UPDATE SIABFACIL.FAMILIA SET POSSE_DOMICILIO_ID = NULL WHERE POSSE_DOMICILIO_ID IS NOT NULL AND LOCALIZACAO_MORADIA_ID = 0;

--SCRIPT ATUALIZAR NACIONALIDADE PARA BRASILEIRO REGISTROS EM BRANCO
UPDATE SIABFACIL.PESSOA SET NACIONALIDADE_ID = 1 WHERE NACIONALIDADE_ID IS NULL;

--SCRIPT ATUALIZAR ESCOLARIDADE PARA ALFABETIZADO REGISTROS EM BRANCO
UPDATE SIABFACIL.PESSOA SET ESCOLARIDADE_ID = 2 WHERE ESCOLARIDADE_ID IS NULL;

--SCRIPT ATUALIZAR DATA_ATIVACAO QDO NULL
UPDATE SIABFACIL.PESSOA SET DATA_ATIVACAO = '2016-03-01' WHERE DATA_ATIVACAO IS NULL;

--SCRIPT ATUALIZAR FREQUENTA ESCOLA PARA NAO QDO MORADOR DE RUA
UPDATE SIABFACIL.PESSOA SET FREQUENTA_ESCOLA = FALSE WHERE SITUACAO_RUA = TRUE;

--SCRIPT ATUALIZAR POSICAO FAMILIAR PARA NAO PARENTE QDO MORADOR DE RUA
UPDATE SIABFACIL.PESSOA SET POSICAO_FAMILIAR_ID = 99 WHERE SITUACAO_RUA = TRUE;

--SCRIPT ATUALIZAR FAMILIA DA EQUIPE CNAR PARA MORADOR DE RUA
UPDATE SIABFACIL.PESSOA SET FAMILIA_ID = 53912 WHERE SITUACAO_RUA = TRUE;

--SCRIPT ATUALIZAR MUNICIPIO DE NASCIMENTO STA ISABEL REGISTROS EM BRANCO
UPDATE SIABFACIL.PESSOA SET COD_MUN_NASCIMENTO = '3304557' WHERE COD_MUN_NASCIMENTO IS NULL; 
-- Código do municipio de Nascimento SP 3550308
-- Código do MUNICIPIO de nascimento RJ 3304557

--SCRIPT ATUALIZAR RACA/COR PARA BRANCO REGISTROS EM BRANCO OU 99 (NAO INFORMADO)
UPDATE SIABFACIL.PESSOA SET CD_RACA = '01' WHERE CD_RACA IS NULL OR CD_RACA = '99';

--SCRIPT RETIRAR AS MASCARAS DO CAMPOS DE TELEFONES DA PESSOA
UPDATE SIABFACIL.PESSOA SET telefone = translate(translate(translate(translate(translate(pessoa.telefone, '-', ''), '(', ''), ')', ''), ' ',''), '.', '');
UPDATE SIABFACIL.PESSOA SET telefone_2 = translate(translate(translate(translate(translate(pessoa.telefone_2, '-', ''), '(', ''), ')', ''), ' ',''), '.', '');
UPDATE SIABFACIL.PESSOA SET telefone_3 = translate(translate(translate(translate(translate(pessoa.telefone_3, '-', ''), '(', ''), ')', ''), ' ',''), '.', '');

--SCRIPT CORRIGIR TELEFONES COM MAIS OU MENOS DE 11 E 10 DIGITOS
UPDATE SIABFACIL.PESSOA SET TELEFONE = (CASE WHEN LENGTH(TELEFONE)<10 THEN NULL ELSE TELEFONE END);
UPDATE SIABFACIL.PESSOA SET TELEFONE = (CASE WHEN LENGTH(TELEFONE)>11 THEN NULL ELSE TELEFONE END);

--SCRIPT CORRIGIR DESCRICAO NOME DA MAE NAO INFORMADO
UPDATE SIABFACIL.PESSOA SET NOME_DA_MAE = 'NAO INFORMADO' WHERE NOME_DA_MAE = 'NI';

UPDATE SIABFACIL.PESSOA SET EMAIL = NULL;

--SCRIPT RETIRAR NAO SABE DAS DOENCAS (ALGUNS ACS REGISTRARAM NAO SABEM COMO REFERENTE A DOENCA E NAO AO SINTOMA DELA)
DELETE FROM SIABFACIL.PESSOA_DOENCA_RINS WHERE DOENCA_RINS_ID = 29;
DELETE FROM SIABFACIL.PESSOA_DOENCA_RESPIRATORIA WHERE DOENCA_RESPIRATORIA_ID = 33;
DELETE FROM SIABFACIL.PESSOA_DOENCA_CARDIACA WHERE DOENCA_CARDIACA_ID = 26;

--RETIRAR MASCARA DO TELEFONE DA FAMILIA E AJUSTAR VALIDACAO QDO LOCALIZACAO URBANA
UPDATE SIABFACIL.FAMILIA SET telefone = translate(translate(translate(translate(translate(familia.telefone, '-', ''), '(', ''), ')', ''), ' ',''), '.', '');
UPDATE SIABFACIL.FAMILIA SET TELEFONE = (CASE WHEN LENGTH(TELEFONE)<10 THEN NULL ELSE TELEFONE END);
UPDATE SIABFACIL.FAMILIA SET TELEFONE = (CASE WHEN LENGTH(TELEFONE)>11 THEN NULL ELSE TELEFONE END);
UPDATE SIABFACIL.FAMILIA SET LOCALIZACAO_MORADIA_ID = 0 WHERE LOCALIZACAO_MORADIA_ID IS NULL;
UPDATE SIABFACIL.FAMILIA SET SITUACAO_MORADIA_ID = 7 WHERE SITUACAO_MORADIA_ID IS NULL;
UPDATE SIABFACIL.FAMILIA SET POSSE_DOMICILIO_ID = 7 WHERE POSSE_DOMICILIO_ID IS NULL AND LOCALIZACAO_MORADIA_ID = 1;
UPDATE SIABFACIL.FAMILIA SET LOGRADOURO_ID = (select id from siabfacil.logradouro where nome like 'Não Informado') WHERE LOGRADOURO_ID IS NULL;

--CORRIGIR STRING NO CAMPO CEP DA LOCALIDADE
UPDATE SIABFACIL.LOCALIDADE SET NU_CEP8 = NULL WHERE NU_CEP8 = 'null';

--SCRIPTS PARA CORRIGIR PESSOAS COM NOME, NOME DA MAE E APELIDO INCOMPLETOS (APENAS O NOME)
UPDATE SIABFACIL.PESSOA SET NOME = NOME || ' D' WHERE ID IN (
select ID from siabfacil.pessoa where position(' ' in nome) = 0 AND FAMILIA_ID IS NOT NULL);

UPDATE SIABFACIL.PESSOA SET NOME_DA_MAE = 'NAO INFORMADO' WHERE ID IN (
select ID from siabfacil.pessoa where position(' ' in nome_da_mae) = 0 AND FAMILIA_ID IS NOT NULL);

UPDATE SIABFACIL.PESSOA SET APELIDO = NULL WHERE ID IN (
select ID from siabfacil.pessoa where position(' ' in apelido) = 0 AND FAMILIA_ID IS NOT NULL);
